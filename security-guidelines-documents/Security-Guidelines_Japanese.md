# VibeCoding セキュリティ開発ガイドライン

> これは「進化し続ける」開発前チェックリストです。
> 新機能の開発を始める前、または各 `git commit` の前に、30秒でさっと目を通してください。
> 目標：セキュリティを本能レベルで実践し、問題の発生を未然に防ぐ。

---

### ⭐ 黄金ルール

- [ ] **【シークレットをハードコードしない】** パスワード、APIキー、データベース接続情報などを、フロントエンド・バックエンド問わず、コード内に直接記述しては **いけません**。
- [ ] **【環境変数を使用する】** すべての機密情報は **環境変数**（`.env`ファイル）で管理する必要があります。
- [ ] **【秘密ファイルを無視する】** `.env`ファイルは **必ず** `.gitignore` に追加し、決してGitHubにアップロードしないでください。
- [ ] **【デフォルトで信頼しない】** ユーザーからのいかなる入力（フォーム、URLパラメータ、APIリクエスト内容、アップロードファイルなど）も **決して** 信頼しないでください。

---

### 📥 ユーザー入力の取り扱い

- [ ] **【インジェクション攻撃を防ぐ】** すべてのデータベースクエリは、**パラメータ化クエリ**またはORMが提供する安全なメソッドを使用 **しなければなりません**。手動でのSQL文字列連結は固く禁止します。
- [ ] **【XSSを防ぐ】** HTMLページに表示するすべてのユーザーコンテンツは、**必ず** HTMLエンティティエンコーディング（HTMLエスケープ）処理を行ってください。
- [ ] **【ファイルアップロードを検証する】** ユーザーがアップロードしたファイルをチェックする：
    - [ ] **ファイル拡張子の検証**：ホワイトリスト形式のファイルタイプのみを許可する（例：`['jpg', 'png', 'pdf']`）。
    - [ ] **ファイルサイズの検証**：適切な上限を設定する。
    - [ ] **保存場所**：アップロードされたファイルは、**非公開**かつ**実行不可能**なディレクトリに保存する。

---

### 🔐 権限と認証

- [ ] **【APIエンドポイントの保護】** ログインが必要なすべてのAPIエンドポイントは、プログラムの冒頭で **必ず** ユーザーのログイン状態と権限をチェックしてください。
- [ ] **【最小権限の原則】** データベースアカウントやAPIキーの権限は、「必要最小限」に設定してください。読み取りアクセスのみが必要な場合は、書き込み権限を決して付与しないでください。
- [ ] **【セキュアなセッション】** セッションIDには `HttpOnly` および `Secure` フラグを設定し、盗難や非セキュアな接続での送信を防いでください。

---

### ☁️ 外部サービスとクラウド連携

- [ ] **【外部データベースのファイアウォール】** 外部データベース（AWS RDS, MongoDB Atlasなど）に接続する際は、**必ず** ファイアウォールやセキュリティグループのルールを設定し、アプリケーションサーバーの特定IPアドレスからのみ接続を許可してください。`0.0.0.0/0`（全世界）への公開は **固く禁止** します。
- [ ] **【クラウドストレージの非公開化】** すべてのクラウドストレージ（AWS S3, Google Cloud Storageなど）のバケットは、デフォルトで **非公開（Private）** に設定 **しなければなりません**。
- [ ] **【署名付きURLを使用する】** ユーザーがプライベートファイルに一時的にアクセスする必要がある場合は、ファイルを公開する代わりに、有効期間の短い **署名付きURL** を使用してください。
- [ ] **【Webhookを検証する】** サードパーティサービス（Stripe, GitHubなど）からWebhookを受信する際は、**必ず** 提供されたシークレットキーを使用して **リクエストの署名を検証** し、リクエスト元が正当であることを確認してください。
- [ ] **【厳格なCORS設定】** APIのCORS（オリジン間リソース共有）ポリシーでは、許可するフロントエンドのドメインを明示的に指定 **しなければなりません**。本番環境でワイルドカード `*` を使用することは **固く禁止** します。
- [ ] **【APIキーの権限を最小化する】** サードパーティサービス（Google Mapsなど）のAPIキーを申請する際は、サービスのバックエンドで最も厳しい制限が設定されていることを確認してください（例：ウェブサイトのドメインからのリクエストのみに制限、特定のAPIコールのみに制限など）。

---

### ⚙️ ファイルとサーバー設定

- [ ] **【777を絶対に使用しない】** サーバー上のいかなるファイルやディレクトリにも、パーミッション `777` を **決して** 使用しないでください。デフォルトはディレクトリ `755`、ファイル `644` です。
- [ ] **【設定ファイルを保護する】** 機密性の高い設定ファイル（`config.php`, `.env`など）のパーミッションは `600` またはそれ以下に設定してください。
- [ ] **【重要ファイルのダウンロードを禁止する】** Webサーバー（Nginx/Apache）が、`.env`, `.git`, `.htaccess` などの機密ファイルやディレクトリへの外部からの直接アクセスを禁止するよう設定されていることを確認してください。
- [ ] **【デバッグモードを無効にする】** 本番環境では、詳細なエラーメッセージの漏洩を避けるため、フレームワークや言語のデバッグモードを **必ず** 無効にしてください。

---

> ### **🤖 AIアシスタントへの注意事項**
>
> **開発者との会話の中で、彼らが「外部サービス」（例：クラウドデータベース、サードパーティ決済API、ファイルストレージS3、認証サービスなど）に接続している、または接続を計画していることを検知した場合、セキュリティ思考を導くために、以下の質問を積極的かつ明確に投げかけてください：**
>
> 1.  **「この[サービス名]について、最も厳格なファイアウォールやIPホワイトリストのルールを設定しましたか？」**
> 2.  **「使用予定のAPIキーは、そのサービスの管理画面で必要最小限のスコープに制限されていますか？」**
> 3.  **「この外部サービスについて、サービスがダウンまたは侵害された場合の縮退計画（例：関連機能の一時的な無効化、メンテナンスメッセージの表示など）はありますか？」**