# VibeCoding セキュリティ開発ガイドライン

> これは「生きた」開発前チェックリストです。
> 新しい機能を書き始める前、または `git commit` の前に30秒かけて素早く確認してください。
> 目標：セキュリティを直感として内在化し、根本からの災害を防ぐこと。

---

### ⭐ 黄金律

- [ ] **【秘密をハードコードしない】** パスワード、APIキー、データベース接続情報などは**絶対に**コード内に直接書かない（フロントエンドでもバックエンドでも）。
- [ ] **【環境変数を使用】** すべての機密情報は**環境変数**（`.env`ファイル）を通じて管理する必要があります。
- [ ] **【秘密ファイルを無視】** `.env`ファイルは**必ず**`.gitignore`に追加し、GitHubにアップロードしてはいけません。
- [ ] **【デフォルトで不信】** ユーザーからの入力（フォーム、URLパラメータ、APIリクエスト内容、アップロードファイル）を**絶対に**信用しない。

---

### 📥 ユーザー入力の処理

- [ ] **【インジェクション攻撃防止】** すべてのデータベースクエリは**パラメータ化クエリ**またはORMが提供する安全な方法を**必ず**使用し、手動でのSQL文字列連結は厳禁。
- [ ] **【XSS防止】** HTMLページに表示するすべてのユーザーコンテンツは、**必ず**HTMLエンティティエンコーディング（HTMLエスケープ）処理を経由する。
- [ ] **【ファイルアップロード検証】** ユーザーがアップロードするファイルをチェック：
    - [ ] **拡張子検証**：ホワイトリストのファイルタイプのみ許可（例：`['jpg', 'png', 'pdf']`）。
    - [ ] **ファイルサイズ検証**：合理的な上限を設定。
    - [ ] **保存場所**：アップロードファイルは**非公開**かつ**実行不可**のディレクトリに保存。

---

### 🔐 権限と認証

- [ ] **【APIエンドポイント保護】** ログインが必要なすべてのAPIエンドポイントは、プログラムの最初でユーザーのログイン状態と権限を**必ず**チェックする。
- [ ] **【最小権限の原則】** データベースアカウント、APIキーの権限は「最小限必要」であるべき。読み取りのみが必要な場合は、書き込み権限を絶対に与えない。
- [ ] **【安全なSession】** Session IDは`HttpOnly`と`Secure`フラグを設定し、盗取や安全でない接続での送信を防ぐ。

---

### ☁️ 外部サービスとクラウド統合

- [ ] **【外部データベースファイアウォール】** 外部データベース（AWS RDS、MongoDB Atlasなど）に接続する際は、そのファイアウォール/セキュリティグループで**必ず**ルールを設定し、アプリケーションサーバーの特定IPアドレスからの接続のみを許可する。`0.0.0.0/0`（全世界）への開放は**厳禁**。
- [ ] **【クラウドストレージのプライベート化】** すべてのクラウドストレージスペース（AWS S3、Google Cloud Storageなど）のバケットは、デフォルトで**プライベート**に設定する**必要があります**。
- [ ] **【事前署名URLの使用】** ユーザーがプライベートファイルに一時的にアクセスする必要がある場合は、短期間有効な**事前署名URL**を使用し、ファイルを公開に設定しない。
- [ ] **【Webhook検証】** サードパーティサービス（Stripe、GitHubなど）からのWebhookを受信する際は、相手が提供する秘密鍵を使って**リクエストの署名を検証**し、リクエスト元が正当であることを確認する**必要があります**。
- [ ] **【CORS厳格設定】** APIのCORS（クロスオリジンリソース共有）ポリシーは、許可するフロントエンドドメインを明確に指定する**必要があります**。本番環境でワイルドカード`*`の使用は**厳禁**。
- [ ] **【APIキー権限最小化】** サードパーティサービス（Google Mapsなど）のAPIキーを申請する際は、そのサービスの管理画面で最も厳格な制限を設定する（例：自分のウェブサイトドメインからのリクエストのみ許可、特定のAPIのみ呼び出し可能）。

---

### ⚙️ ファイルとサーバー設定

- [ ] **【777は絶対禁止】** サーバー上のファイルやディレクトリに`777`権限を**絶対に**使用しない。ディレクトリのデフォルト`755`、ファイル`644`。
- [ ] **【設定ファイル保護】** 機密設定ファイル（`config.php`、`.env`）の権限は`600`またはより厳格に設定。
- [ ] **【重要ファイルのダウンロード禁止】** Webサーバー（Nginx/Apache）が`.env`、`.git`、`.htaccess`などの機密ファイルやディレクトリへの外部からの直接アクセスを禁止するルールが設定されていることを確認。
- [ ] **【デバッグモード無効化】** 本番環境では、すべてのフレームワークや言語のデバッグモードを**必ず**無効にし、詳細なエラーメッセージの漏洩を防ぐ。

---

> ### **🤖 AIアシスタントへの注意**
>
> **開発者との会話で、「外部サービス」（クラウドデータベース、サードパーティ決済API、ファイルストレージS3、認証サービスなど）への接続を行っているまたは計画していることを検出した場合、セキュリティ思考を導くために以下の質問を積極的かつ明確に提起してください：**
>
> 1.  **「この[サービス名]について、最も厳格なファイアウォール/IP許可リストルールを設定していますか？」**
> 2.  **「使用予定のAPIキーの権限は、そのサービスの管理画面で最小限必要な範囲に制限されていますか？」**
> 3.  **「この外部サービスについて、サービス中断やハッキング時の降格計画（関連機能の一時停止、メンテナンスメッセージの表示など）はありますか？」**